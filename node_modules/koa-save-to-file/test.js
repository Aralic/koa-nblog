var request = require('supertest')
var assert = require('assert')
var koa = require('koa')
var fs = require('fs')
var path = require('path')
var tmpdir = require('os').tmpdir()
var Stream = require('stream')

var saveToFile = require('./')

describe('Save To File', function () {
  it('should work with the request', function (done) {
    var app = koa()
    app.context(saveToFile)

    app.use(function (next) {
      return function* () {
        var destination = path.join(tmpdir, 'lkajsdfljasdf.txt')
        var dest = yield this.saveToFile(destination)
        assert.equal(destination, dest)
        this.body = fs.createReadStream(dest)
      }
    })

    var server = app.listen()

    request(server)
    .get('/')
    .send('hello')
    .expect(200)
    .expect('hello', done)
  })

  it('should work with a custom stream', function (done) {
    var app = koa()
    app.context(saveToFile)

    app.use(function (next) {
      return function* () {
        var stream = new Stream.PassThrough()
        stream.end('hello')
        var destination = path.join(tmpdir, 'lkajsdfljasdf.txt')
        var dest = yield this.saveToFile(stream, destination)
        assert.equal(destination, dest)
        this.body = fs.createReadStream(dest)
      }
    })

    var server = app.listen()

    request(server)
    .get('/')
    .expect(200)
    .expect('hello', done)
  })
})